#!/bin/bash

test_header() {
    g++ -x c++ - -o /dev/null 2>/dev/null << EOF
       #include <$1>
       int main() { return 0; }
EOF
}

test_kqueue() {
    g++ -x c++ - -o /dev/null 2>/dev/null << EOF
       #include <sys/types.h>
       #include <sys/event.h>
       #include <sys/time.h>
       int main() {
           return kqueue();
       }
EOF
}

OUTPUT=$1
if test -z "$OUTPUT"; then
    echo "Usage: $0 <output file>"
    echo "eg:"
    echo "    $0 config.h"
    exit 1
fi

rm -rf $OUTPUT
touch $OUTPUT

if test -z "$CXX"; then
    CXX=g++
fi

if [ ! -d "bin" ]; then
    `mkdir bin`
fi

pgsize=`getconf PAGESIZE`

echo "/*" >> $OUTPUT
echo " * This file is auto generated by $0, " >> $OUTPUT
echo " * if you DONOT konw what you are doing, " >> $OUTPUT
echo " * DONOT modify this file." >> $OUTPUT
echo " * " >> $OUTPUT
echo " * author: Liu Wei" >> $OUTPUT
echo " * mail: stupidlw@126.com" >> $OUTPUT
echo " * github: github.com/brg-liuwei" >> $OUTPUT
echo " * blog: brg-liuwei.github.io" >> $OUTPUT
echo " */" >> $OUTPUT
echo "" >> $OUTPUT

echo "#ifndef __CONFIG_H__" >> $OUTPUT
echo "#define __CONFIG_H__" >> $OUTPUT

echo "" >> $OUTPUT
echo "#define PAGESIZE $pgsize" >> $OUTPUT

$(test_header malloc.h)
if [ "$?" == 0 ]; then
    echo "#define FY_HAVE_MALLOC_H" >> $OUTPUT
fi

$(test_header stdlib.h)
if [ "$?" == 0 ]; then
    echo "#define FY_HAVE_STDLIB_H" >> $OUTPUT
fi

$(test_header sys/types.h)
if [ "$?" == 0 ]; then
    echo "#define FY_HAVE_SYS_TYPES_H" >> $OUTPUT
fi

$(test_header sys/epoll.h)
if [ "$?" == 0 ]; then
    echo "#define HAVE_EPOLL" >> $OUTPUT
fi

$(test_kqueue)
if [ "$?" == 0 ]; then
    echo "#define HAVE_KQUEUE" >> $OUTPUT
fi

echo "" >> $OUTPUT
echo "#endif" >> $OUTPUT
